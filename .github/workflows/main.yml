name: deploy-nonprod

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Static analysis 
        run: echo "Running SAST scan..."
      - name: Dependency vulnerability scan 
        run: echo "Scanning dependencies..."
      - name: Secret scan 
        run: echo "Secret scan complete."

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies 
        run: echo "Installing project dependencies..."
      - name: Run unit tests 
        run: |
          echo "Executing unit tests..."
          echo "All unit tests passed."

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - name: Start integration test services 
        run: echo "Starting docker-compose services..."
      - name: Run integration tests 
        run: echo "Integration tests passed."
      - name: Tear down services 
        if: always()
        run: echo "Stopping services..."

  canary-deploy:
    name: Canary Deploy
    runs-on: ubuntu-latest
    needs: integration-tests
    environment: dev
    steps:
      - uses: actions/checkout@v4
      - name: Canary deploy 
        run: echo "Simulating canary deployment to a subset of dev..."
      - name: Canary verification 
        run: echo "Performing simulated health checks... All good."

  deploy-nonprod:
    name: Full Deploy (Dev)
    needs: canary-deploy
    environment: dev
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Do infra
        run: |
          az account show
